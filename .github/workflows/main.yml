name:  Build Aseprite (Manual)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        
    - name:  Install Windows dependencies
      run: |
        choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        choco install -y ninja
        
    - name:  Download Skia
      run: |
        $url = "https://github.com/aseprite/skia/releases/latest/download/Skia-Windows-Release-x64.zip"
        Invoke-WebRequest -Uri $url -OutFile "skia.zip"
        Expand-Archive -Path "skia.zip" -DestinationPath "C:/deps/skia" -Force
        
    - name:  Configure
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo `
              -DLAF_BACKEND=skia `
              -DSKIA_DIR=C:/deps/skia `
              -DSKIA_LIBRARY_DIR=C:/deps/skia/out/Release-x64 `
              -DSKIA_LIBRARY=C:/deps/skia/out/Release-x64/skia.lib `
              -G Ninja ..
              
    - name:  Build
      run: |
        cd build
        ninja aseprite
        
    - name:  Package
      run: |
        mkdir aseprite-portable
        copy build\bin\aseprite.exe aseprite-portable\
        copy build\bin\*.dll aseprite-portable\ 2>$null || echo "No DLLs"
        xcopy build\bin\data aseprite-portable\data /E /I /Y
        
    - name:  Upload
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-windows
        path: aseprite-portable/*
        retention-days: 1
